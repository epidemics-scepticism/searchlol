/*
    Copyright (C) 2016 cacahuatl < cacahuatl at autistici dot org >

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include "onion.h"

const unsigned char onion_chars[32] = {'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h',
                                       'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p',
                                       'q', 'r', 's', 't', 'u', 'v', 'w', 'x',
                                       'y', 'z', '2', '3', '4', '5', '6', '7'};

const unsigned char onion_values[256] = {
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a,
    0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16,
    0x17, 0x18, 0x19, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20,
};

static unsigned char onion_char(const unsigned char c) {
  return onion_chars[c & 0x1f];
}

static unsigned char onion_value(const unsigned char c) {
  return onion_values[c] & 0x1f;
}

static void onion_decode_block(unsigned char *dst, const unsigned char *src) {
  dst[0] = onion_value(src[0]) << 3 & 0xf8;
  dst[0] |= onion_value(src[1]) >> 2 & 0x07;
  dst[1] = onion_value(src[1]) << 6 & 0xc0;
  dst[1] |= onion_value(src[2]) << 1 & 0x3e;
  dst[1] |= onion_value(src[3]) >> 4 & 0x01;
  dst[2] = onion_value(src[3]) << 4 & 0xf0;
  dst[2] |= onion_value(src[4]) >> 1 & 0x0f;
  dst[3] = onion_value(src[4]) << 7 & 0x80;
  dst[3] |= onion_value(src[5]) << 2 & 0x7c;
  dst[3] |= onion_value(src[6]) >> 3 & 0x3;
  dst[4] = onion_value(src[6]) << 5 & 0xe0;
  dst[4] |= onion_value(src[7]) & 0x1f;
}

static void onion_encode_block(unsigned char *dst, const unsigned char *src) {
  dst[0] = onion_char(src[0] >> 3);
  dst[1] = onion_char(src[0] << 2 | src[1] >> 6);
  dst[2] = onion_char(src[1] >> 1);
  dst[3] = onion_char(src[1] << 4 | src[2] >> 4);
  dst[4] = onion_char(src[2] << 1 | src[3] >> 7);
  dst[5] = onion_char(src[3] >> 2);
  dst[6] = onion_char(src[3] << 3 | src[4] >> 5);
  dst[7] = onion_char(src[4]);
}

bool onion_only(const unsigned char *word) {
  if (!word)
    goto fail;
  for (const unsigned char *o = word; *o; o++) {
    if (0x20 == onion_values[*o])
      goto fail;
  }
  return true;
fail:
  return false;
}

void onion_decode(unsigned char *dst, const unsigned char *src) {
  onion_decode_block(&dst[0], &src[0]);
  onion_decode_block(&dst[5], &src[8]);
}

void onion_encode(unsigned char *dst, const unsigned char *src) {
  onion_encode_block(&dst[0], &src[0]);
  onion_encode_block(&dst[8], &src[5]);
}
